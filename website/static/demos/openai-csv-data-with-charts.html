<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with CSV Data + Charts - Deep Chat + OpenAI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.22.3/styles/salesforce-lightning-design-system.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Salesforce Sans', Arial, sans-serif;
      background: #f3f3f3;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .slds-scope {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .app-header {
      background: linear-gradient(to right, #032d60, #0176d3);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .app-header h1 {
      font-size: 1.75rem;
      font-weight: 300;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .app-header .slds-badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Main container - full width */
    .main-container {
      flex: 1;
      display: flex;
      gap: 0;
      background: #f3f3f3;
    }

    /* Sidebar */
    .sidebar {
      width: 380px;
      background: white;
      border-right: 1px solid #d8dde6;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .sidebar-content {
      padding: 1.5rem;
      flex: 1;
    }

    /* Chat area - takes remaining width */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      position: relative;
    }

    /* SLDS Card modifications */
    .slds-card {
      margin-bottom: 1rem;
    }

    .slds-card__header {
      padding: 0.75rem 1rem;
    }

    .slds-card__body {
      padding: 0.75rem 1rem;
    }

    /* Form elements */
    .slds-form-element {
      margin-bottom: 1rem;
    }

    .slds-input,
    .slds-textarea {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
    }

    /* Buttons */
    .slds-button {
      transition: all 0.2s ease;
    }

    .slds-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Status alerts */
    .status-alert {
      margin-bottom: 1rem;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Chat container */
    #chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #chat {
      flex: 1;
      min-height: 0;
      display: none;
    }

    #chat.visible {
      display: block;
    }

    /* Config section */
    #configSection {
      padding: 1.5rem;
    }

    #configSection.hidden {
      display: none;
    }

    /* Feature list */
    .feature-list {
      list-style: none;
      padding: 0;
    }

    .feature-list li {
      padding: 0.5rem 0;
      padding-left: 1.75rem;
      position: relative;
      line-height: 1.5;
    }

    .feature-list li:before {
      content: "âœ“";
      position: absolute;
      left: 0;
      color: #0176d3;
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* Example URLs */
    .url-list {
      list-style: none;
      padding: 0;
    }

    .url-list li {
      margin: 0.5rem 0;
    }

    .url-code {
      background: #f3f3f3;
      padding: 0.5rem 0.75rem;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.8125rem;
      display: block;
      word-break: break-all;
      border-left: 3px solid #0176d3;
    }

    /* Loading spinner */
    .slds-spinner_container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .slds-spinner_container.active {
      display: flex;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #d8dde6;
      }
    }

    /* Reset button */
    .reset-section {
      padding: 1rem 1.5rem;
      border-top: 1px solid #d8dde6;
      background: #fafaf9;
    }

    /* Hide scrollbar for sidebar */
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #f3f3f3;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #d8dde6;
      border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: #c9ced6;
    }
  </style>
  <script type="module">
    // Chart generation functions
    function generateQuickChartUrl(config) {
      const encodedConfig = encodeURIComponent(JSON.stringify(config));
      return `https://quickchart.io/chart?c=${encodedConfig}&width=800&height=500`;
    }

    function createLineChart({ title, labels, datasets }) {
      return {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets.map(dataset => ({
            label: dataset.label,
            data: dataset.data,
            borderColor: dataset.color || 'rgb(1, 118, 211)',
            backgroundColor: dataset.color || 'rgba(1, 118, 211, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
          })),
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title, font: { size: 18, weight: 'bold' } },
            legend: { display: true, position: 'top' },
          },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          },
        },
      };
    }

    function createBarChart({ title, labels, datasets }) {
      return {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets.map(dataset => ({
            label: dataset.label,
            data: dataset.data,
            backgroundColor: dataset.color || 'rgba(1, 118, 211, 0.8)',
            borderColor: dataset.color || 'rgb(1, 118, 211)',
            borderWidth: 1,
          })),
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title, font: { size: 18, weight: 'bold' } },
            legend: { display: true, position: 'top' },
          },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          },
        },
      };
    }

    function createPieChart({ title, labels, data, colors }) {
      return {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors || [
              'rgba(1, 118, 211, 0.8)',
              'rgba(11, 92, 171, 0.8)',
              'rgba(194, 57, 52, 0.8)',
              'rgba(255, 186, 10, 0.8)',
              'rgba(87, 163, 0, 0.8)',
            ],
          }],
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: title, font: { size: 18, weight: 'bold' } },
            legend: { display: true, position: 'right' },
          },
        },
      };
    }

    // OpenAI function definitions
    const chartFunctions = [
      {
        type: 'function',
        function: {
          name: 'create_line_chart',
          description: 'Creates a line chart to visualize trends over time or ordered categories',
          parameters: {
            type: 'object',
            properties: {
              title: { type: 'string', description: 'The title of the chart' },
              labels: { type: 'array', items: { type: 'string' }, description: 'X-axis labels' },
              datasets: {
                type: 'array',
                items: {
                  type: 'object',
                  properties: {
                    label: { type: 'string' },
                    data: { type: 'array', items: { type: 'number' } },
                    color: { type: 'string' },
                  },
                  required: ['label', 'data'],
                },
              },
            },
            required: ['title', 'labels', 'datasets'],
          },
        },
      },
      {
        type: 'function',
        function: {
          name: 'create_bar_chart',
          description: 'Creates a bar chart to compare values across categories',
          parameters: {
            type: 'object',
            properties: {
              title: { type: 'string' },
              labels: { type: 'array', items: { type: 'string' } },
              datasets: {
                type: 'array',
                items: {
                  type: 'object',
                  properties: {
                    label: { type: 'string' },
                    data: { type: 'array', items: { type: 'number' } },
                    color: { type: 'string' },
                  },
                  required: ['label', 'data'],
                },
              },
            },
            required: ['title', 'labels', 'datasets'],
          },
        },
      },
      {
        type: 'function',
        function: {
          name: 'create_pie_chart',
          description: 'Creates a pie chart to show proportions or distribution',
          parameters: {
            type: 'object',
            properties: {
              title: { type: 'string' },
              labels: { type: 'array', items: { type: 'string' } },
              data: { type: 'array', items: { type: 'number' } },
              colors: { type: 'array', items: { type: 'string' } },
            },
            required: ['title', 'labels', 'data'],
          },
        },
      },
    ];

    // Data loader utilities
    async function fetchRemoteData(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.text();
    }

    function parseCSV(csvText, delimiter = ',') {
      const lines = csvText.trim().split('\n');
      if (lines.length === 0) return [];

      const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(delimiter).map(v => v.trim().replace(/^"|"$/g, ''));
        if (values.length === headers.length) {
          const row = {};
          headers.forEach((header, index) => { row[header] = values[index]; });
          data.push(row);
        }
      }
      return data;
    }

    async function loadRemoteData(url, type = 'csv') {
      const rawData = await fetchRemoteData(url);
      if (type === 'csv') return parseCSV(rawData);
      if (type === 'json') return JSON.parse(rawData);
      throw new Error(`Unsupported type: ${type}`);
    }

    function createDataContextPrompt(data, basePrompt = '', maxRows = 50) {
      const limitedData = data.slice(0, maxRows);
      const headers = Object.keys(limitedData[0]);

      let formatted = `${basePrompt}\n\nYou have access to the following dataset:\n\n`;
      formatted += `Data Summary (${data.length} total rows, showing ${limitedData.length}):\n`;
      formatted += `Columns: ${headers.join(', ')}\n\nSample Data:\n`;

      limitedData.forEach((row, index) => {
        formatted += `Row ${index + 1}: ${JSON.stringify(row)}\n`;
      });

      formatted += `\n\nIMPORTANT: When the user asks to visualize data or create charts, use the appropriate chart creation functions (create_line_chart, create_bar_chart, or create_pie_chart) to generate visual representations.`;

      return formatted;
    }

    // Initialize chat
    async function initializeChat() {
      const apiKeyInput = document.getElementById('apiKey');
      const dataUrlInput = document.getElementById('dataUrl');
      const loadButton = document.getElementById('loadButton');
      const statusDiv = document.getElementById('status');
      const chatElement = document.getElementById('chat');
      const configSection = document.getElementById('configSection');
      const spinner = document.getElementById('spinner');

      const apiKey = apiKeyInput.value.trim();
      const dataUrl = dataUrlInput.value.trim();

      if (!apiKey) {
        showStatus('error', 'Please enter your OpenAI API key');
        return;
      }

      if (!dataUrl) {
        showStatus('error', 'Please enter a data URL');
        return;
      }

      try {
        loadButton.disabled = true;
        spinner.classList.add('active');
        showStatus('info', 'Loading data from remote source...');

        const fileType = dataUrl.endsWith('.json') ? 'json' : 'csv';
        const data = await loadRemoteData(dataUrl, fileType);

        if (!data || (Array.isArray(data) && data.length === 0)) {
          throw new Error('No data loaded from file');
        }

        showStatus('info', `Data loaded successfully! ${Array.isArray(data) ? data.length : 'N/A'} rows. Initializing AI...`);

        const systemPrompt = createDataContextPrompt(
          data,
          'You are a helpful data analyst assistant. When users ask for visualizations or charts, use the appropriate chart creation functions to generate them.',
          50
        );

        const functionHandler = async (functionsDetails) => {
          const results = [];
          for (const detail of functionsDetails) {
            const args = JSON.parse(detail.arguments);
            const chartUrl = generateChartUrl(detail.name, args);
            results.push({ response: chartUrl });
          }
          return results;
        };

        function generateChartUrl(functionName, args) {
          let config;

          switch (functionName) {
            case 'create_line_chart':
              config = createLineChart(args);
              break;
            case 'create_bar_chart':
              config = createBarChart(args);
              break;
            case 'create_pie_chart':
              config = createPieChart(args);
              break;
            default:
              return `Error: Unknown function ${functionName}`;
          }

          return generateQuickChartUrl(config);
        }

        chatElement.directConnection = {
          openAI: {
            key: apiKey,
            chat: {
              system_prompt: systemPrompt,
              model: 'gpt-4o',
              max_tokens: 2000,
              temperature: 0.7,
              tools: chartFunctions,
              function_handler: functionHandler,
            },
          },
        };

        chatElement.responseInterceptor = (response) => {
          if (response.text && response.text.includes('quickchart.io')) {
            const urlMatch = response.text.match(/https:\/\/quickchart\.io\/chart\?[^\s)]+/);
            if (urlMatch) {
              const chartUrl = urlMatch[0];
              response.html = `<div style="margin: 20px 0; text-align: center; padding: 20px; background: #fafaf9; border-radius: 8px;">
                <img src="${chartUrl}" alt="Chart" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
              </div>`;
            }
          }
          return response;
        };

        chatElement.htmlClassOverrides = { default: {} };

        chatElement.classList.add('visible');
        configSection.classList.add('hidden');
        spinner.classList.remove('active');
        showStatus('success', 'Ready! Ask me to analyze or visualize your data.');

        console.log('Data loaded successfully with chart support!');
      } catch (error) {
        console.error('Error:', error);
        showStatus('error', `Failed to load data: ${error.message}`);
        loadButton.disabled = false;
        spinner.classList.remove('active');
      }
    }

    function showStatus(type, message) {
      const statusDiv = document.getElementById('status');
      const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        warning: 'âš ',
        info: 'â„¹'
      };

      const classMap = {
        success: 'slds-theme_success',
        error: 'slds-theme_error',
        warning: 'slds-theme_warning',
        info: 'slds-theme_info'
      };

      statusDiv.innerHTML = `
        <div class="slds-notify slds-notify_alert ${classMap[type]} status-alert" role="alert">
          <span class="slds-assistive-text">${type}</span>
          <span class="slds-icon_container slds-m-right_x-small">
            <span>${iconMap[type]}</span>
          </span>
          <h2>${message}</h2>
        </div>
      `;
    }

    function resetDemo() {
      const chatElement = document.getElementById('chat');
      const configSection = document.getElementById('configSection');
      const statusDiv = document.getElementById('status');
      const loadButton = document.getElementById('loadButton');

      chatElement.classList.remove('visible');
      configSection.classList.remove('hidden');
      statusDiv.innerHTML = '';
      loadButton.disabled = false;
    }

    window.addEventListener('load', () => {
      document.getElementById('loadButton').addEventListener('click', initializeChat);
      document.getElementById('resetButton').addEventListener('click', resetDemo);

      document.getElementById('apiKey').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') initializeChat();
      });
      document.getElementById('dataUrl').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') initializeChat();
      });
    });
  </script>
</head>
<body>
  <div class="slds-scope">
    <!-- Header -->
    <header class="app-header">
      <h1>
        <span>ðŸ“Š Data Analysis & Visualization</span>
        <span class="slds-badge slds-badge_lightest">AI-Powered</span>
        <span class="slds-badge slds-badge_lightest">Charts</span>
      </h1>
    </header>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-content">
          <!-- Features Card -->
          <article class="slds-card">
            <div class="slds-card__header slds-grid">
              <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__body">
                  <h2 class="slds-card__header-title">
                    <span>Key Features</span>
                  </h2>
                </div>
              </header>
            </div>
            <div class="slds-card__body slds-card__body_inner">
              <ul class="feature-list">
                <li>Load CSV/JSON from Google Cloud Storage</li>
                <li>AI-powered data analysis with GPT-4</li>
                <li>Automatic chart generation</li>
                <li>Line, bar, and pie charts</li>
                <li>Natural language queries</li>
                <li>Real-time visualizations</li>
              </ul>
            </div>
          </article>

          <!-- Example Questions Card -->
          <article class="slds-card">
            <div class="slds-card__header slds-grid">
              <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__body">
                  <h2 class="slds-card__header-title">
                    <span>Example Questions</span>
                  </h2>
                </div>
              </header>
            </div>
            <div class="slds-card__body slds-card__body_inner">
              <ul class="feature-list" style="font-size: 0.875rem;">
                <li>"Show me a line chart of sepal length"</li>
                <li>"Create a bar chart comparing species"</li>
                <li>"Make a pie chart of the distribution"</li>
                <li>"What's the average petal width?"</li>
                <li>"Visualize the correlation between variables"</li>
              </ul>
            </div>
          </article>

          <!-- Test URLs Card -->
          <article class="slds-card">
            <div class="slds-card__header slds-grid">
              <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__body">
                  <h2 class="slds-card__header-title">
                    <span>Test Data URLs</span>
                  </h2>
                </div>
              </header>
            </div>
            <div class="slds-card__body slds-card__body_inner">
              <ul class="url-list">
                <li>
                  <strong class="slds-text-body_small">Iris Dataset</strong>
                  <code class="url-code">https://raw.githubusercontent.com/plotly/datasets/master/iris.csv</code>
                </li>
                <li>
                  <strong class="slds-text-body_small">Tips Dataset</strong>
                  <code class="url-code">https://raw.githubusercontent.com/plotly/datasets/master/tips.csv</code>
                </li>
              </ul>
            </div>
          </article>
        </div>

        <!-- Reset Button at bottom of sidebar -->
        <div class="reset-section">
          <button id="resetButton" class="slds-button slds-button_outline-brand slds-button_stretch">
            ðŸ”„ Reset & Try Another Dataset
          </button>
        </div>
      </aside>

      <!-- Chat Area -->
      <main class="chat-area">
        <!-- Loading Spinner -->
        <div id="spinner" class="slds-spinner_container">
          <div role="status" class="slds-spinner slds-spinner_medium">
            <span class="slds-assistive-text">Loading</span>
            <div class="slds-spinner__dot-a"></div>
            <div class="slds-spinner__dot-b"></div>
          </div>
        </div>

        <!-- Configuration Section -->
        <div id="configSection" class="slds-p-around_large">
          <div class="slds-text-heading_medium slds-m-bottom_medium">Configuration</div>

          <div id="status"></div>

          <div class="slds-form" role="list">
            <div class="slds-form-element">
              <label class="slds-form-element__label" for="dataUrl">
                <abbr class="slds-required" title="required">* </abbr>Data URL (CSV or JSON)
              </label>
              <div class="slds-form-element__control">
                <input type="text" id="dataUrl" class="slds-input"
                  placeholder="https://raw.githubusercontent.com/plotly/datasets/master/iris.csv"
                  value="https://raw.githubusercontent.com/plotly/datasets/master/iris.csv" />
              </div>
              <div class="slds-form-element__help">Enter the public URL of your CSV or JSON file</div>
            </div>

            <div class="slds-form-element">
              <label class="slds-form-element__label" for="apiKey">
                <abbr class="slds-required" title="required">* </abbr>OpenAI API Key
              </label>
              <div class="slds-form-element__control">
                <input type="password" id="apiKey" class="slds-input" placeholder="sk-..." />
              </div>
              <div class="slds-form-element__help">Your API key stays in your browser and is never stored</div>
            </div>

            <div class="slds-m-top_large">
              <button id="loadButton" class="slds-button slds-button_brand slds-button_stretch">
                ðŸš€ Load Data & Start Analysis
              </button>
            </div>
          </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-wrapper">
          <deep-chat id="chat" style="width: 100%; height: 100%;"></deep-chat>
        </div>
      </main>
    </div>
  </div>

  <script type="module" src="https://cdn.jsdelivr.net/npm/deep-chat"></script>
</body>
</html>
